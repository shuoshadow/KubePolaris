---
sidebar_position: 4
---

# èŠ‚ç‚¹ç®¡ç†

æœ¬æ–‡æ¡£ä»‹ç»å¦‚ä½•åœ¨ KubePolaris ä¸­æŸ¥çœ‹å’Œç®¡ç† Kubernetes é›†ç¾¤èŠ‚ç‚¹ã€‚

## æŸ¥çœ‹èŠ‚ç‚¹

### èŠ‚ç‚¹åˆ—è¡¨

è¿›å…¥ **èŠ‚ç‚¹ç®¡ç†** é¡µé¢æŸ¥çœ‹æ‰€æœ‰èŠ‚ç‚¹ï¼š

| ä¿¡æ¯ | è¯´æ˜ |
|------|------|
| èŠ‚ç‚¹åç§° | èŠ‚ç‚¹ä¸»æœºå |
| çŠ¶æ€ | Ready/NotReady/Unknown |
| è§’è‰² | Master/Worker |
| ç‰ˆæœ¬ | kubelet ç‰ˆæœ¬ |
| å†…éƒ¨ IP | èŠ‚ç‚¹å†…ç½‘ IP |
| OS | æ“ä½œç³»ç»Ÿ |
| å†…æ ¸ç‰ˆæœ¬ | Linux å†…æ ¸ç‰ˆæœ¬ |
| å®¹å™¨è¿è¡Œæ—¶ | Docker/containerd/CRI-O |
| CPU/å†…å­˜ | èµ„æºå®¹é‡å’Œä½¿ç”¨ç‡ |
| Pod æ•°é‡ | è¿è¡Œä¸­çš„ Pod æ•° |

### èŠ‚ç‚¹çŠ¶æ€

| çŠ¶æ€ | è¯´æ˜ |
|------|------|
| ğŸŸ¢ **Ready** | èŠ‚ç‚¹å¥åº·ï¼Œå¯è°ƒåº¦ Pod |
| ğŸ”´ **NotReady** | èŠ‚ç‚¹ä¸å¥åº· |
| âšª **Unknown** | æ— æ³•è·å–çŠ¶æ€ |
| ğŸŸ¡ **SchedulingDisabled** | å·²ç¦æ­¢è°ƒåº¦ |

### èŠ‚ç‚¹è¯¦æƒ…

ç‚¹å‡»èŠ‚ç‚¹åç§°è¿›å…¥è¯¦æƒ…é¡µï¼š

#### æ¦‚è§ˆ
- åŸºæœ¬ä¿¡æ¯ï¼ˆåç§°ã€IPã€åˆ›å»ºæ—¶é—´ï¼‰
- ç³»ç»Ÿä¿¡æ¯ï¼ˆOSã€æ¶æ„ã€å†…æ ¸ç‰ˆæœ¬ï¼‰
- å®¹å™¨è¿è¡Œæ—¶ä¿¡æ¯
- èµ„æºå®¹é‡å’Œå¯åˆ†é…é‡

#### èµ„æºä½¿ç”¨
- CPU ä½¿ç”¨ç‡
- å†…å­˜ä½¿ç”¨ç‡
- ç£ç›˜ä½¿ç”¨ç‡
- Pod æ•°é‡

#### Pod åˆ—è¡¨
è¿è¡Œåœ¨è¯¥èŠ‚ç‚¹ä¸Šçš„æ‰€æœ‰ Podã€‚

#### æ ‡ç­¾å’Œæ³¨è§£
èŠ‚ç‚¹çš„æ‰€æœ‰æ ‡ç­¾å’Œæ³¨è§£ã€‚

#### æ±¡ç‚¹
èŠ‚ç‚¹é…ç½®çš„æ±¡ç‚¹åˆ—è¡¨ã€‚

#### çŠ¶æ€æ¡ä»¶
- Ready
- MemoryPressure
- DiskPressure
- PIDPressure
- NetworkUnavailable

#### äº‹ä»¶
èŠ‚ç‚¹ç›¸å…³çš„äº‹ä»¶è®°å½•ã€‚

## èŠ‚ç‚¹æ“ä½œ

### Cordonï¼ˆç¦æ­¢è°ƒåº¦ï¼‰

å°†èŠ‚ç‚¹æ ‡è®°ä¸ºä¸å¯è°ƒåº¦ï¼š

1. ç‚¹å‡»èŠ‚ç‚¹è¡Œçš„ **ç¦æ­¢è°ƒåº¦** æŒ‰é’®
2. ç¡®è®¤æ“ä½œ

æ•ˆæœï¼š
- æ–° Pod ä¸ä¼šè°ƒåº¦åˆ°è¯¥èŠ‚ç‚¹
- ç°æœ‰ Pod ç»§ç»­è¿è¡Œ
- èŠ‚ç‚¹çŠ¶æ€æ˜¾ç¤º `SchedulingDisabled`

ä½¿ç”¨åœºæ™¯ï¼š
- å‡†å¤‡ç»´æŠ¤èŠ‚ç‚¹
- èŠ‚ç‚¹å³å°†ä¸‹çº¿

ç­‰åŒäºï¼š
```bash
kubectl cordon <node-name>
```

### Uncordonï¼ˆæ¢å¤è°ƒåº¦ï¼‰

æ¢å¤èŠ‚ç‚¹è°ƒåº¦ï¼š

1. ç‚¹å‡» **æ¢å¤è°ƒåº¦** æŒ‰é’®
2. ç¡®è®¤æ“ä½œ

ç­‰åŒäºï¼š
```bash
kubectl uncordon <node-name>
```

### Drainï¼ˆæ’ç©ºèŠ‚ç‚¹ï¼‰

å®‰å…¨åœ°è¿ç§»èŠ‚ç‚¹ä¸Šçš„ Podï¼š

1. ç‚¹å‡» **æ’ç©ºèŠ‚ç‚¹** æŒ‰é’®
2. é…ç½®æ’ç©ºé€‰é¡¹ï¼š
   - **å¿½ç•¥ DaemonSet**: æ˜¯å¦å¿½ç•¥ DaemonSet ç®¡ç†çš„ Pod
   - **å¼ºåˆ¶åˆ é™¤**: æ˜¯å¦å¼ºåˆ¶åˆ é™¤æœ¬åœ°å­˜å‚¨çš„ Pod
   - **è¶…æ—¶æ—¶é—´**: ç­‰å¾… Pod ä¼˜é›…ç»ˆæ­¢çš„æ—¶é—´
3. ç¡®è®¤æ‰§è¡Œ

æ•ˆæœï¼š
- èŠ‚ç‚¹è¢«æ ‡è®°ä¸ºä¸å¯è°ƒåº¦
- ç°æœ‰ Pod è¢«é©±é€åˆ°å…¶ä»–èŠ‚ç‚¹
- DaemonSet Pod é»˜è®¤ä¿ç•™

ä½¿ç”¨åœºæ™¯ï¼š
- èŠ‚ç‚¹ç»´æŠ¤
- èŠ‚ç‚¹ä¸‹çº¿
- ç³»ç»Ÿå‡çº§

ç­‰åŒäºï¼š
```bash
kubectl drain <node-name> \
  --ignore-daemonsets \
  --delete-emptydir-data \
  --timeout=300s
```

:::warning æ³¨æ„
æ’ç©ºæ“ä½œä¼šé©±é€èŠ‚ç‚¹ä¸Šçš„ Podï¼Œè¯·ç¡®ä¿æœ‰è¶³å¤Ÿçš„èµ„æºåœ¨å…¶ä»–èŠ‚ç‚¹è¿è¡Œè¿™äº› Podã€‚
:::

### SSH ç»ˆç«¯

ç›´æ¥ SSH åˆ°èŠ‚ç‚¹ï¼š

1. ç‚¹å‡» **SSH** æŒ‰é’®
2. é€‰æ‹©è®¤è¯æ–¹å¼ï¼ˆå¯†ç /å¯†é’¥ï¼‰
3. åœ¨ Web ç»ˆç«¯ä¸­æ“ä½œ

è¯¦è§ [ç»ˆç«¯è®¿é—®](./terminal-access)ã€‚

### ç®¡ç†æ ‡ç­¾

æ·»åŠ æˆ–åˆ é™¤èŠ‚ç‚¹æ ‡ç­¾ï¼š

1. è¿›å…¥èŠ‚ç‚¹è¯¦æƒ… â†’ **æ ‡ç­¾**
2. ç‚¹å‡» **ç¼–è¾‘**
3. æ·»åŠ /ä¿®æ”¹/åˆ é™¤æ ‡ç­¾
4. ä¿å­˜

å¸¸ç”¨æ ‡ç­¾ç¤ºä¾‹ï¼š
```yaml
node-type: compute
zone: cn-beijing-a
environment: production
team: platform
```

### ç®¡ç†æ±¡ç‚¹

æ·»åŠ æˆ–åˆ é™¤èŠ‚ç‚¹æ±¡ç‚¹ï¼š

1. è¿›å…¥èŠ‚ç‚¹è¯¦æƒ… â†’ **æ±¡ç‚¹**
2. ç‚¹å‡» **ç¼–è¾‘**
3. æ·»åŠ /ä¿®æ”¹/åˆ é™¤æ±¡ç‚¹
4. ä¿å­˜

æ±¡ç‚¹æ ¼å¼ï¼š
```yaml
key: value:Effect
```

Effect ç±»å‹ï¼š
- `NoSchedule`: ä¸è°ƒåº¦æ–° Pod
- `PreferNoSchedule`: å°½é‡ä¸è°ƒåº¦
- `NoExecute`: é©±é€ç°æœ‰ Pod

ç¤ºä¾‹ï¼š
```bash
# æ·»åŠ æ±¡ç‚¹
kubectl taint nodes <node-name> key=value:NoSchedule

# åˆ é™¤æ±¡ç‚¹
kubectl taint nodes <node-name> key-
```

## èŠ‚ç‚¹ç›‘æ§

### å†…ç½®ç›‘æ§

æŸ¥çœ‹åŸºç¡€æŒ‡æ ‡ï¼š

- CPU ä½¿ç”¨ç‡
- å†…å­˜ä½¿ç”¨ç‡
- ç£ç›˜ä½¿ç”¨ç‡
- ç½‘ç»œæµé‡
- Pod æ•°é‡

### Prometheus æŒ‡æ ‡

é…ç½® Prometheus åå¯æŸ¥çœ‹ï¼š

- è¯¦ç»†èµ„æºä½¿ç”¨è¶‹åŠ¿
- èŠ‚ç‚¹è´Ÿè½½å†å²
- IO ç­‰å¾…æ—¶é—´
- ç½‘ç»œè¿æ¥æ•°

### å‘Šè­¦è§„åˆ™

å¸¸è§èŠ‚ç‚¹å‘Šè­¦ï¼š

| å‘Šè­¦ | æ¡ä»¶ | ä¸¥é‡ç¨‹åº¦ |
|------|------|---------|
| èŠ‚ç‚¹ NotReady | çŠ¶æ€æŒç»­ 5 åˆ†é’Ÿ | Critical |
| CPU ä½¿ç”¨ç‡é«˜ | > 80% æŒç»­ 15 åˆ†é’Ÿ | Warning |
| å†…å­˜ä½¿ç”¨ç‡é«˜ | > 85% æŒç»­ 15 åˆ†é’Ÿ | Warning |
| ç£ç›˜ä½¿ç”¨ç‡é«˜ | > 90% | Warning |
| Pod æ•°é‡æ¥è¿‘ä¸Šé™ | > 90% å®¹é‡ | Warning |

## é—®é¢˜è¯Šæ–­

### èŠ‚ç‚¹ NotReady

å¸¸è§åŸå› ï¼š

1. **kubelet é—®é¢˜**
   ```bash
   # æ£€æŸ¥ kubelet çŠ¶æ€
   systemctl status kubelet
   journalctl -u kubelet -n 100
   ```

2. **ç½‘ç»œé—®é¢˜**
   - æ£€æŸ¥èŠ‚ç‚¹ç½‘ç»œè¿é€šæ€§
   - æ£€æŸ¥ CNI æ’ä»¶çŠ¶æ€

3. **èµ„æºè€—å°½**
   - æ£€æŸ¥ç£ç›˜ç©ºé—´
   - æ£€æŸ¥å†…å­˜ä½¿ç”¨

4. **è¯ä¹¦é—®é¢˜**
   - æ£€æŸ¥è¯ä¹¦æ˜¯å¦è¿‡æœŸ

### DiskPressure

ç£ç›˜ç©ºé—´ä¸è¶³ï¼š

1. æ¸…ç†æ— ç”¨é•œåƒ
   ```bash
   docker system prune -af
   # æˆ–
   crictl rmi --prune
   ```

2. æ¸…ç†æ—¥å¿—
   ```bash
   journalctl --vacuum-time=3d
   ```

3. æ‰©å±•ç£ç›˜ç©ºé—´

### MemoryPressure

å†…å­˜ä¸è¶³ï¼š

1. æ£€æŸ¥å†…å­˜æ³„æ¼çš„ Pod
2. é©±é€ä½ä¼˜å…ˆçº§ Pod
3. å¢åŠ èŠ‚ç‚¹å†…å­˜

### ç½‘ç»œé—®é¢˜

1. æ£€æŸ¥ç½‘ç»œæ’ä»¶çŠ¶æ€
2. æ£€æŸ¥ iptables è§„åˆ™
3. æ£€æŸ¥ DNS è§£æ

## æœ€ä½³å®è·µ

### èŠ‚ç‚¹è§„åˆ’

- ç”Ÿäº§ç¯å¢ƒè‡³å°‘ 3 ä¸ª Master èŠ‚ç‚¹
- Worker èŠ‚ç‚¹æ•°é‡æ ¹æ®è´Ÿè½½è§„åˆ’
- é¢„ç•™è¶³å¤Ÿçš„èµ„æºä½™é‡

### æ ‡ç­¾ç­–ç•¥

ä½¿ç”¨æ ‡ç­¾ç»„ç»‡èŠ‚ç‚¹ï¼š

```yaml
# åŒºåŸŸ
topology.kubernetes.io/zone: cn-beijing-a

# èŠ‚ç‚¹ç±»å‹
node-type: compute
node-type: gpu
node-type: memory-optimized

# ç¯å¢ƒ
environment: production

# å›¢é˜Ÿ
team: platform
```

### æ±¡ç‚¹ä½¿ç”¨

åˆç†ä½¿ç”¨æ±¡ç‚¹ï¼š

```yaml
# Master èŠ‚ç‚¹
node-role.kubernetes.io/master:NoSchedule

# GPU èŠ‚ç‚¹
nvidia.com/gpu:NoSchedule

# ä¸“ç”¨èŠ‚ç‚¹
dedicated=special:NoSchedule
```

### èµ„æºé¢„ç•™

é…ç½®ç³»ç»Ÿé¢„ç•™èµ„æºï¼š

```yaml
# kubelet é…ç½®
kubeReserved:
  cpu: 200m
  memory: 500Mi
systemReserved:
  cpu: 200m
  memory: 500Mi
evictionHard:
  memory.available: 500Mi
  nodefs.available: 10%
```

## ä¸‹ä¸€æ­¥

- [ç»ˆç«¯è®¿é—®](./terminal-access) - SSH åˆ°èŠ‚ç‚¹
- [ç›‘æ§å‘Šè­¦](./monitoring-alerting) - é…ç½®èŠ‚ç‚¹ç›‘æ§

